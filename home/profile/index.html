<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <style>
        /**
         * 字体定义
         * --------------------------------------
         */
        @font-face {
            font-family: 'JetBrains Mono';
            src: url('/static/fonts/JetBrainsMono-ExtraLight.woff2') format('woff2');
            font-weight: 200;
            font-style: normal;
            font-display: swap;
        }
        
        /**
         * 全局变量和基础样式
         * --------------------------------------
         */
        :root {
            --font-sans: 'Microsoft YaHei', 'PingFang SC', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --color-bg: #000000;
            --color-text: #ffffff;
            --color-text-secondary: #cccccc;
            --color-text-tertiary: #aaaaaa;
            --color-border: #333333;
            --color-card-bg: #0c0c0c;
            --color-item-bg: #1a1a1a;
            --color-item-hover: #2a2a2a;
            --color-success: #4caf50;
            --color-warning: #ff9800;
            --color-error: #f44336;
            --radius-normal: 12px;
            --radius-large: 24px;
            --shadow-normal: 0 8px 12px rgba(0, 0, 0, 0.3);
            --anim-duration: 0.3s;
        }
        
        body {
            font-family: var(--font-sans);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 0;
        }
        
        h1, h2, h3, h4, h5, h6, .card-title {
            font-family: var(--font-sans);
        }
        
        .item-title, .item-desc {
            font-family: var(--font-sans);
        }
        
        input, select, textarea, button {
            font-family: var(--font-sans);
        }
        
        /**
         * 页面加载动画
         * --------------------------------------
         */        
        /* 页面内容加载效果 */
        .page-content {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        
        .page-content.loaded {
            opacity: 1;
            transform: translateY(0);
        }
        
        /**
         * 卡片组件样式
         * --------------------------------------
         */
        /* 卡片基础样式 */
        .card {
            background-color: var(--color-card-bg);
            border-radius: var(--radius-normal);
            padding: 25px;
            box-shadow: var(--shadow-normal);
            border: 1px solid var(--color-border);
            min-width: 250px;
            transition: transform var(--anim-duration) ease, 
                        box-shadow var(--anim-duration) ease, 
                        border-color var(--anim-duration) ease, 
                        opacity 0.5s ease;
            opacity: 0;
            transform: translateY(15px);
        }
        
        @media (min-width: 768px) {
            .card {
                border-radius: var(--radius-large);
                padding: 24px;
                gap: 14px;
                box-shadow: 0 51px 20px rgba(0, 0, 0, 0.01), 
                           0 29px 17px rgba(0, 0, 0, 0.05), 
                           0 13px 13px rgba(0, 0, 0, 0.09), 
                           0 3px 7px rgba(0, 0, 0, 0.1);
            }
        }
        
        .card.loaded {
            opacity: 1;
            transform: translateY(0);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 16px rgba(0, 0, 0, 0.4);
            border-color: #555555;
        }
        
        /* 卡片类型样式 */
        .card-basic {
            grid-area: basic;
            min-height: 90px;
            align-self: start;
            padding: 24px;
            margin-bottom: 0;
        }
        
        .card-basic .card-title {
            font-size: 1.5rem;
            margin-bottom: 8px;
            margin-top: 10px;
        }
        
        .card-basic .info-item {
            margin-bottom: 10px;
        }
        
        .card-basic .info-label {
            font-size: 1rem;
            min-width: 100px;
        }
        
        .card-count {
            grid-area: count;
            align-self: start;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding-bottom: 15px;
        }
        
        .card-count .inner-box {
            width: calc(100% - 32px);
        }
        
        .card-count .card-title {
            margin-bottom: 5px;
        }
        
        .card-count .info-item {
            margin-bottom: 5px;
        }
        
        .card-links {
            grid-area: links;
            margin-top: 0;
            padding-bottom: 15px;
            height: auto;
            display: flex;
            flex-direction: column;
        }
        
        .card-clients {
            grid-area: clients;
            margin-top: 0;
        }
        
        /* 非基本卡片的标题样式 */
        .card:not(.card-basic) .card-title {
            margin-bottom: 15px;
            margin-top: 8px;
        }
        
        /**
         * 导航栏样式
         * --------------------------------------
         */
        .navbar {
            background-color: var(--color-bg);
            border-radius: var(--radius-normal);
            margin: 15px 60px;
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-normal);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            width: calc(100% - 120px);
            box-sizing: border-box;
            transition: box-shadow var(--anim-duration) ease, opacity 0.5s ease;
            opacity: 0;
        }
        
        .navbar.loaded {
            opacity: 1;
        }
        
        .navbar.scrolled {
            box-shadow: 0 0 20px 8px rgba(255, 255, 255, 0.1);
        }
        
        .navbar-brand {
            font-family: var(--font-sans);
            font-size: 24px;
            font-weight: bold;
            color: var(--color-text);
            text-decoration: none;
        }
        
        .navbar-nav {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .nav-item {
            margin: 0 15px;
        }
        
        .nav-link {
            font-family: var(--font-sans);
            color: var(--color-text-secondary);
            text-decoration: none;
            font-size: 16px;
            transition: color 0.2s ease;
        }
        
        .nav-link:hover {
            color: var(--color-text);
        }
        
        /**
         * 个人资料图标与下拉菜单
         * --------------------------------------
         */
        .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            background-color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .profile-icon svg {
            width: 24px;
            height: 24px;
            fill: var(--color-text);
        }
        
        .profile-dropdown {
            position: absolute;
            top: 55px;
            right: 0;
            background-color: #111111;
            border-radius: var(--radius-normal);
            border: 1px solid var(--color-border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            width: 250px;
            z-index: 1000;
            display: none;
        }
        
        .profile-dropdown.show {
            display: block;
        }
        
        .dropdown-item {
            display: block;
            padding: 12px 16px;
            color: var(--color-text);
            text-decoration: none;
            border-bottom: 1px solid #222222;
            font-family: var(--font-sans);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background-color: #222222;
        }
        
        .dropdown-divider {
            height: 1px;
            background-color: var(--color-border);
            margin: 0;
        }
        
        .dropdown-disabled {
            color: #666666;
            cursor: not-allowed;
        }
        
        .dropdown-disabled:hover {
            background-color: transparent;
        }
        
        .user-info-container {
            padding: 16px;
            border-bottom: 1px solid #222222;
        }
        
        #dropdown-user-name {
            font-size: 18px;
            font-weight: bold;
            margin: 0 0 5px 0;
            text-transform: uppercase;
        }
        
        #dropdown-user-email {
            font-size: 14px;
            color: var(--color-text-tertiary);
            margin: 0;
            word-break: break-all;
        }
        
        /**
         * 主内容区域布局
         * --------------------------------------
         */
        .profile-container {
            max-width: 1100px;
            margin: 120px auto 30px;
            padding: 0 40px;
        }
        
        h1.page-title {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .page-description {
            color: var(--color-text-secondary);
            margin-bottom: 40px;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: 0.8fr 1.2fr;
            grid-template-rows: auto auto auto;
            grid-template-areas: 
                "basic count"
                "links count"
                "clients count";
            gap: 25px;
            margin-bottom: 35px;
        }
        
        /**
         * 头像组件样式
         * --------------------------------------
         */
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .avatar-container {
            position: relative;
            width: 100px;
            height: 100px;
            margin-right: 20px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
        }
        
        .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #333333;
            transition: filter var(--anim-duration) ease;
        }
        
        .avatar-upload {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.3);
            color: var(--color-text);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 32px;
            font-weight: 300;
            opacity: 0;
            transition: opacity var(--anim-duration) ease;
        }
        
        .avatar-container:hover .avatar {
            filter: grayscale(50%);
        }
        
        .avatar-container:hover .avatar-upload {
            opacity: 1;
        }
        
        .avatar-upload-input {
            display: none;
        }
        
        .user-name {
            font-size: 20px;
            font-weight: bold;
            margin: 0 0 5px 0;
            font-family: var(--font-sans);
        }
        
        .user-email {
            color: var(--color-text-tertiary);
            margin: 0;
            font-family: var(--font-sans);
        }
        
        /**
         * 通知提示组件
         * --------------------------------------
         */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: #333333;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: transform var(--anim-duration), opacity var(--anim-duration);
            transform: translateY(-20px);
            opacity: 0;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background-color: var(--color-success);
        }
        
        .toast.error {
            background-color: var(--color-error);
        }
        
        /**
         * 信息项和徽章样式
         * --------------------------------------
         */
        .info-item {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .info-label {
            min-width: 150px;
            color: var(--color-text);
            text-align: left;
            font-weight: bold;
            font-family: var(--font-sans);
        }
        
        .info-value {
            flex: 1;
            color: var(--color-text);
            text-align: right;
            font-family: var(--font-sans);
        }
        
        .verified-badge {
            display: inline-block;
            background-color: var(--color-success);
            color: white;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            margin-right: 10px;
        }
        
        .not-verified-badge {
            display: inline-block;
            background-color: var(--color-warning);
            color: white;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            margin-right: 10px;
        }
        
        /**
         * 进度条相关样式
         * --------------------------------------
         */
        .progress-bar {
            height: 8px;
            background-color: var(--color-item-bg);
            border-radius: 4px;
            margin-top: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--color-success);
            border-radius: 4px;
            width: 0%;
            transition: width 1.5s cubic-bezier(0.22, 0.61, 0.36, 1);
            position: relative;
        }
        
        /* 闪光效果容器 */
        .shimmer-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }
        
        .shimmer-container.active {
            opacity: 1;
        }
        
        .shimmer-container.fadeout {
            opacity: 0;
            transition: opacity 1s ease-out;
        }
        
        /* 闪光动画元素 */
        .shimmer-element {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.2) 50%,
                transparent 100%
            );
            animation: shimmer-move 1.5s linear infinite;
        }
        
        @keyframes shimmer-move {
            0% {
                transform: translateX(-50%);
            }
            100% {
                transform: translateX(50%);
            }
        }
        
        .usage-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--color-text-tertiary);
            margin-top: 4px;
            line-height: 1.5;
        }
        
        .mono-text {
            font-family: var(--font-mono);
            font-weight: 200;
            letter-spacing: -0.02em;
            color: #bbb;
        }
        
        .mono-text strong {
            color: var(--color-text);
            font-weight: 400;
        }
        
        /**
         * 按钮样式
         * --------------------------------------
         */
        .btn {
            font-family: var(--font-sans);
            display: inline-block;
            background-color: #222222;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            border: none;
            margin-right: 10px;
            cursor: pointer;
            transition: background-color var(--anim-duration) ease;
        }
        
        .btn:hover {
            background-color: #333333;
        }
        
        .btn-primary {
            background-color: var(--color-text);
            color: var(--color-bg);
        }
        
        .btn-primary:hover {
            background-color: #dddddd;
        }
        
        /**
         * 会话和活动项组件
         * --------------------------------------
         */
        .sessions-list {
            margin-top: 20px;
        }
        
        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--color-item-bg);
            padding: 14px 16px;
            border-radius: var(--radius-normal);
            border: 1px solid rgba(51, 51, 51, 0.5);
            margin-bottom: 10px;
            transition: all var(--anim-duration) ease;
        }
        
        .session-item:hover {
            background-color: var(--color-item-hover);
            transform: translateX(5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .session-info {
            display: flex;
            align-items: center;
        }
        
        .device-icon {
            margin-right: 15px;
            font-size: 20px;
        }
        
        .session-details {
            color: var(--color-text-tertiary);
            font-size: 14px;
            margin-top: 3px;
        }
        
        .revoke-btn {
            background-color: #333333;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color var(--anim-duration) ease;
        }
        
        .revoke-btn:hover {
            background-color: #444444;
        }
        
        .loading-indicator {
            text-align: center;
            color: var(--color-text-tertiary);
            font-size: 14px;
        }
        
        /**
         * 快速连接和互动项目
         * --------------------------------------
         */
        /* 快速连接特定样式 */
        .quick-links {
            margin-top: 15px;
            margin-bottom: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        /* 互动项目通用样式（快速连接和最近登录客户端） */
        .interactive-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 14px;
            background-color: var(--color-item-bg);
            border-radius: var(--radius-normal);
            border: 1px solid rgba(51, 51, 51, 0.5);
            transition: all var(--anim-duration) ease;
            text-decoration: none;
            color: var(--color-text);
        }
        
        .interactive-item:hover {
            background-color: var(--color-item-hover);
            transform: translateX(5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .interactive-item:last-child {
            margin-bottom: 5px;
        }
        
        .item-icon {
            margin-right: 12px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--color-text);
        }
        
        .item-text {
            flex: 1;
        }
        
        .item-title {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .item-desc {
            font-size: 12px;
            color: var(--color-text-tertiary);
        }
        
        /**
         * 内部框架样式
         * --------------------------------------
         */
        .inner-box {
            background-color: var(--color-bg);
            border-radius: 8px;
            border: 1px solid var(--color-border);
            padding: 16px;
            margin-top: 2px;
        }
        
        .inner-box-title {
            font-family: var(--font-sans);
            font-weight: bold;
            margin-bottom: 12px;
            font-size: 1rem;
            line-height: 1.4;
        }
        
        /**
         * 响应式设计
         * --------------------------------------
         */
        @media (min-width: 768px) {
            .session-item {
                border-radius: 16px;
                padding: 16px 18px;
            }
        }
        
        @media (max-width: 1024px) {
            .navbar {
                margin: 15px 40px;
                width: calc(100% - 80px);
            }
            
            .profile-container {
                padding: 0 30px;
            }
        }
        
        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: 1fr;
                grid-template-areas: 
                    "basic"
                    "count"
                    "links"
                    "clients";
                gap: 20px;
            }
            
            .navbar {
                margin: 10px 20px;
                width: calc(100% - 40px);
            }
            
            .profile-container {
                margin: 100px auto 20px;
                padding: 0 20px;
            }
            
            h1.page-title {
                font-size: 36px;
            }
            
            .card-basic,
            .card-count {
                min-height: auto;
            }
            
            .quick-link-item,
            .interactive-item {
                padding: 12px;
            }
            
            .session-item {
                padding: 12px 14px;
            }
        }
        
        @media (max-width: 480px) {
            .navbar-nav {
                display: none;
            }
            
            .header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .avatar-container {
                margin-right: 0;
                margin-bottom: 20px;
            }
            
            .interactive-item,
            .session-item {
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar">
        <a href="/" class="navbar-brand">LycreX</a>
        
        <ul class="navbar-nav">
            <li class="nav-item">
                <a href="https://lycrex.com" class="nav-link">LYCREX</a>
            </li>
            <li class="nav-item">
                <a href="https://git.lycrex.com" class="nav-link">GIT</a>
            </li>
            <li class="nav-item">
                <a href="https://lab.lycrex.com" class="nav-link">LAB</a>
            </li>
        </ul>
        
        <!-- 用户个人资料图标与下拉菜单 -->
        <div class="profile-icon" id="profileIcon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2a7.2 7.2 0 01-6-3.22c.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08a7.2 7.2 0 01-6 3.22z"/>
            </svg>
            
            <div class="profile-dropdown" id="profileDropdown">
                <div class="user-info-container">
                    <div class="user-name" id="dropdown-user-name">加载中...</div>
                    <div class="user-email" id="dropdown-user-email">加载中...</div>
                </div>
                <div class="dropdown-item dropdown-disabled">个人资料</div>
                <div class="dropdown-item dropdown-disabled">账户设置</div>
                <div class="dropdown-divider"></div>
                <a href="/profile/logout" class="dropdown-item">退出登录</a>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <div class="profile-container page-content">
        <h1 class="page-title">Settings</h1>
        <p class="page-description">You can manage your account, token, and client settings here.</p>

        <!-- 用户头像和基本信息 -->
        <div class="header" style="margin-bottom: 40px;">
            <div class="avatar-container" id="avatar-upload-btn">
                <img id="user-avatar" alt="Avatar" class="avatar">
                <div class="avatar-upload">
                    <span>+</span>
                    <input type="file" id="avatar-input" class="avatar-upload-input" accept="image/png,image/jpeg,image/gif">
                </div>
            </div>
            <div>
                <h2 id="user-name" style="font-size: 32px; margin: 0; color: white;">Loading...</h2>
                <p id="user-email" style="color: #aaaaaa; margin: 5px 0 0 0;">Loading...</p>
            </div>
        </div>

        <!-- 内容卡片网格布局 -->
        <div class="cards-grid">
            <!-- 基本信息卡片 -->
            <div class="card card-basic">
                <h2 class="card-title">Basic Information</h2>
                <div class="info-item">
                    <div class="info-label">Name</div>
                    <div id="info-name" class="info-value">Loading...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">
                        <span id="email-verified-badge" class="not-verified-badge">Loading...</span>
                        <span id="info-email">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- 登录统计卡片 -->
            <div class="card card-count">
                <h2 class="card-title">Login Count</h2>
                
                <div class="inner-box">
                    <div class="inner-box-title">Last 30 Days Login Count</div>
                    <div class="progress-bar">
                        <div id="login-progress" class="progress-fill" style="width: 0%;"></div>
                    </div>
                    <div class="usage-details">
                        <span id="login-count-text" class="mono-text">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- 快速链接卡片 -->
            <div class="card card-links">
                <h2 class="card-title">快速连接</h2>
                <div class="quick-links">
                    <a href="https://lab.lycrex.com" class="interactive-item" target="_blank">
                        <div class="item-icon">🧪</div>
                        <div class="item-text">
                            <div class="item-title">实验室</div>
                            <div class="item-desc">Lab - 探索最新的技术与项目</div>
                        </div>
                    </a>
                    <a href="https://git.lycrex.com" class="interactive-item" target="_blank">
                        <div class="item-icon">🔄</div>
                        <div class="item-text">
                            <div class="item-title">Git 仓库</div>
                            <div class="item-desc">Git - 代码管理与版本控制</div>
                        </div>
                    </a>
                </div>
            </div>

            <!-- 最近登录客户端卡片 -->
            <div class="card card-clients">
                <h2 class="card-title">最近登录的客户端</h2>
                <div id="recent-clients-list" class="sessions-list">
                    <div class="loading-indicator">加载中...</div>
                </div>
            </div>
        </div>

        <!-- 退出登录按钮 -->
        <a href="/profile/logout" class="btn">Log Out</a>
    </div>

    <!-- 消息提示组件 -->
    <div id="toast" class="toast"></div>

    <script>
        /**
         * 全局变量声明
         * --------------------------------------
         */
        // 防止重定向循环的标记
        let redirectAttempted = false;
        
        // DOM引用缓存
        let dropdownUserName;
        let dropdownUserEmail;
        
        // 卡片加载状态标记
        let cardsLoaded = false;
        
        /**
         * 页面初始化
         * --------------------------------------
         */
        document.addEventListener('DOMContentLoaded', function() {
            // 会话检查和重定向处理
            handleSessionCheck();
            
            // 初始化各个模块
            initData();
            initUI();
        });
        
        /**
         * 初始化数据
         * --------------------------------------
         */
        function initData() {
            // 加载用户基本信息
            fetchUserInfo();
            
            // 加载登录统计信息
            fetchLoginStats();
        }
        
        /**
         * 初始化UI组件
         * --------------------------------------
         */
        function initUI() {
            // 初始化下拉菜单
            initProfileDropdown();
            
            // 监听页面滚动，为导航栏添加光晕效果
            initNavbarScrollEffect();

            // 初始化头像上传功能
            initAvatarUpload();
            
            // 初始化页面加载动画
            initPageLoadAnimation();
        }
        
        /**
         * 会话检查和重定向处理
         * --------------------------------------
         */
        function handleSessionCheck() {
            // 检查URL中是否包含错误参数
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('error')) {
                const error = urlParams.get('error');
                
                // 如果存在session_expired错误且没有之前的重定向尝试
                if (error === 'session_expired' && !sessionStorage.getItem('redirectAttempted')) {
                    // 设置标记，避免再次重定向
                    sessionStorage.setItem('redirectAttempted', 'true');
                    
                    // 直接跳转到登录页面
                    window.location.href = '/';
                    return;
                }
            } else {
                // 如果当前页面没有错误参数，清除之前的重定向标记
                sessionStorage.removeItem('redirectAttempted');
            }
        }
        
        /**
         * 动画与视觉效果模块
         * --------------------------------------
         */
        
        /**
         * 初始化页面加载动画
         * 按顺序加载导航栏、页面内容和卡片
         */
        function initPageLoadAnimation() {
            // 显示导航栏
            setTimeout(() => {
                document.querySelector('.navbar').classList.add('loaded');
            }, 100);
            
            // 显示页面内容
            setTimeout(() => {
                document.querySelector('.page-content').classList.add('loaded');
            }, 300);
            
            // 逐个显示卡片
            animateCards();
        }
        
        /**
         * 卡片动画显示效果
         */
        function animateCards() {
            const cards = document.querySelectorAll('.card');
            let lastCardIndex = cards.length - 1;
            
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('loaded');
                    
                    // 当最后一张卡片加载完成后，设置标记
                    if (index === lastCardIndex) {
                        cardsLoaded = true;
                        
                        // 触发自定义事件，通知卡片加载完成
                        document.dispatchEvent(new CustomEvent('cardsLoaded'));
                    }
                }, 500 + (index * 150)); // 每个卡片延迟150ms显示
            });
        }
        
        /**
         * 初始化导航栏滚动效果
         */
        function initNavbarScrollEffect() {
            const navbar = document.querySelector('.navbar');
            window.addEventListener('scroll', function() {
                if (window.scrollY > 10) {
                    navbar.classList.add('scrolled');
                } else {
                    navbar.classList.remove('scrolled');
                }
            });
        }
        
        /**
         * 创建并启动进度条动画
         * @param {number} percentage - 进度百分比(0-100)
         * @param {number} loginCount - 登录次数
         */
        function startProgressAnimation(percentage, loginCount) {
            const progressBar = document.getElementById('login-progress');
            
            // 清理旧的闪光容器（如果有）
            const oldShimmer = document.querySelector('.shimmer-container');
            if (oldShimmer) {
                oldShimmer.parentNode.removeChild(oldShimmer);
            }
            
            // 重置进度条宽度
            progressBar.style.width = '0%';
            
            // 创建新的闪光效果
            const shimmerContainer = document.createElement('div');
            shimmerContainer.className = 'shimmer-container';
            
            const shimmerElement = document.createElement('div');
            shimmerElement.className = 'shimmer-element';
            
            shimmerContainer.appendChild(shimmerElement);
            progressBar.parentNode.appendChild(shimmerContainer);
            
            // 设置进度条宽度
            progressBar.style.width = `${percentage}%`;
            
            // 根据登录次数设置不同的颜色
            updateProgressColor(progressBar, loginCount);
            
            // 显示闪光效果
            setTimeout(() => {
                shimmerContainer.classList.add('active');
                
                // 等待一段时间后平滑淡出闪光效果
                setTimeout(() => {
                    shimmerContainer.classList.add('fadeout');
                    
                    // 淡出完成后删除元素
                    setTimeout(() => {
                        if (shimmerContainer.parentNode) {
                            shimmerContainer.parentNode.removeChild(shimmerContainer);
                        }
                    }, 1100); // 等待淡出完成后再移除（略多于淡出时间）
                }, 2500); // 闪光效果显示2.5秒后开始淡出
            }, 100);
        }
        
        /**
         * 根据登录次数更新进度条颜色
         * @param {HTMLElement} progressBar - 进度条元素
         * @param {number} loginCount - 登录次数
         */
        function updateProgressColor(progressBar, loginCount) {
            if (loginCount <= 30) {
                // 0-30次：绿色
                progressBar.style.backgroundColor = '#4caf50';
            } else if (loginCount <= 60) {
                // 31-60次：黄色
                progressBar.style.backgroundColor = '#ffeb3b';
            } else if (loginCount <= 90) {
                // 61-90次：橙色
                progressBar.style.backgroundColor = '#ff9800';
            } else {
                // 91+次：红色
                progressBar.style.backgroundColor = '#f44336';
            }
        }
        
        /**
         * 交互功能模块
         * --------------------------------------
         */
        
        /**
         * 初始化个人资料下拉菜单
         */
        function initProfileDropdown() {
            const profileIcon = document.getElementById('profileIcon');
            const profileDropdown = document.getElementById('profileDropdown');
            
            // 初始化全局变量
            dropdownUserName = document.getElementById('dropdown-user-name');
            dropdownUserEmail = document.getElementById('dropdown-user-email');
            
            // 点击头像图标显示/隐藏下拉菜单
            profileIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                profileDropdown.classList.toggle('show');
            });
            
            // 点击页面其他地方时关闭下拉菜单
            document.addEventListener('click', function() {
                profileDropdown.classList.remove('show');
            });
        }
        
        /**
         * 初始化头像上传功能
         */
        function initAvatarUpload() {
            const avatarContainer = document.getElementById('avatar-upload-btn');
            const avatarInput = document.getElementById('avatar-input');
            
            // 点击头像容器触发文件选择
            avatarContainer.addEventListener('click', function() {
                avatarInput.click();
            });
            
            // 处理文件选择事件
            avatarInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    
                    // 验证文件
                    if (!validateAvatarFile(file)) return;
                    
                    // 预览图像
                    previewAvatar(file);
                    
                    // 上传头像
                    uploadAvatar(file);
                }
            });
            
            // 阻止冒泡，避免点击input时触发container的点击事件
            avatarInput.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        /**
         * 验证头像文件
         * @param {File} file - 要验证的文件对象
         * @returns {boolean} 验证结果
         */
        function validateAvatarFile(file) {
            // 检查文件大小（限制为4MB）
            if (file.size > 4 * 1024 * 1024) {
                showToast('头像文件过大，请选择小于4MB的图片', 'error');
                return false;
            }
            
            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                showToast('请选择图片文件', 'error');
                return false;
            }
            
            return true;
        }
        
        /**
         * 预览头像图片
         * @param {File} file - 要预览的图片文件
         */
        function previewAvatar(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('user-avatar').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        /**
         * 显示消息提示
         * @param {string} message - 提示消息内容
         * @param {string} type - 提示类型（success/error）
         */
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            // 3秒后自动隐藏
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }
        
        /**
         * 数据处理模块
         * --------------------------------------
         */
        
        /**
         * 获取用户信息
         */
        async function fetchUserInfo() {
            try {
                console.log('正在获取用户信息...');
                const response = await fetch('/profile/api/userinfo');
                
                // 处理响应错误
                if (!response.ok) {
                    handleResponseError(response.status);
                    return;
                }
                
                const userData = await response.json();
                console.log('用户信息获取成功');
                
                // 更新页面上的用户信息
                updateUserInterface(userData);
            } catch (error) {
                console.error('获取用户信息失败:', error);
                
                // 防止无限重定向循环
                if (!redirectAttempted) {
                    redirectAttempted = true;
                }
            }
        }
        
        /**
         * 处理API响应错误
         * @param {number} status - HTTP状态码
         */
        function handleResponseError(status) {
            // 如果响应不成功（如401未授权），重定向到登录页面
            if (status === 401) {
                console.warn('用户未授权，需要重新登录');
                
                // 防止无限重定向循环
                if (!redirectAttempted) {
                    redirectAttempted = true;
                    window.location.href = '/auth?error=session_expired';
                }
                return;
            }
            
            throw new Error(`API请求失败，状态码: ${status}`);
        }

        /**
         * 更新用户界面
         * @param {Object} user - 用户数据对象
         */
        function updateUserInterface(user) {
            // 更新头像
            updateUserAvatar(user);
            
            // 获取用户名
            const username = user.preferred_username || user.name || user.username || '';
            
            // 更新网页标题为用户名
            document.title = username ? username : '个人资料';
            
            // 更新用户名显示
            document.getElementById('user-name').textContent = username;
            document.getElementById('info-name').textContent = username;
            
            // 更新下拉菜单中的用户信息
            if (!dropdownUserName) dropdownUserName = document.getElementById('dropdown-user-name');
            if (!dropdownUserEmail) dropdownUserEmail = document.getElementById('dropdown-user-email');
            
            if (dropdownUserName) dropdownUserName.textContent = username.toUpperCase();
            if (dropdownUserEmail) dropdownUserEmail.textContent = user.email || '';
            
            // 更新邮箱
            document.getElementById('user-email').textContent = user.email || '';
            document.getElementById('info-email').textContent = user.email || '';
            
            // 更新邮箱验证状态
            updateEmailVerificationStatus(user.email_verified);
            
            // 更新最近30天登录次数
            updateLoginCountInfo(user.recent_login_count || 0);
        }
        
        /**
         * 更新用户头像
         * @param {Object} user - 用户数据对象
         */
        function updateUserAvatar(user) {
            const avatarElement = document.getElementById('user-avatar');
            const timestamp = new Date().getTime();
            
            // 设置用户头像
            if (user.avatar_url) {
                // 添加时间戳参数以避免缓存
                const avatarUrl = addTimestampToUrl(user.avatar_url, timestamp);
                avatarElement.src = avatarUrl;
            }
            // 备选方案，如果avatar_url不存在但有其他头像字段
            else if (user.avatar || user.picture) {
                const avatarData = user.avatar || user.picture;
                
                // 检查是否是有效的URL或data URI
                if (avatarData.startsWith('http://') || avatarData.startsWith('https://')) {
                    // 添加时间戳参数以避免缓存
                    const avatarUrl = addTimestampToUrl(avatarData, timestamp);
                    avatarElement.src = avatarUrl;
                } else if (avatarData.startsWith('data:')) {
                    // data URI不需要添加时间戳
                    avatarElement.src = avatarData;
                }
            }
        }
        
        /**
         * 向URL添加时间戳参数
         * @param {string} url - 原始URL
         * @param {number} timestamp - 时间戳
         * @returns {string} 添加时间戳后的URL
         */
        function addTimestampToUrl(url, timestamp) {
            return url.includes('?') 
                ? `${url}&t=${timestamp}` 
                : `${url}?t=${timestamp}`;
        }
        
        /**
         * 更新邮箱验证状态
         * @param {boolean} isVerified - 是否已验证
         */
        function updateEmailVerificationStatus(isVerified) {
            const emailVerifiedBadge = document.getElementById('email-verified-badge');
            if (isVerified) {
                emailVerifiedBadge.textContent = 'Verified';
                emailVerifiedBadge.className = 'verified-badge';
            } else {
                emailVerifiedBadge.textContent = 'Not Verified';
                emailVerifiedBadge.className = 'not-verified-badge';
            }
        }
        
        /**
         * 更新登录次数信息
         * @param {number} loginCount - 登录次数
         */
        function updateLoginCountInfo(loginCount) {
            // 更新登录次数文本
            document.getElementById('login-count-text').innerHTML = 
                `You have logged in <strong>${loginCount}</strong> times in the last 30 days`;
            
            // 计算进度条百分比（最大值为100）
            const maxLogins = 100;
            const percentage = Math.min(100, (loginCount / maxLogins) * 100);
            
            // 检查卡片是否已加载完成
            if (cardsLoaded) {
                // 如果卡片已加载完成，延迟一小段时间后启动进度条动画
                setTimeout(() => startProgressAnimation(percentage, loginCount), 300);
            } else {
                // 如果卡片尚未加载完成，监听卡片加载完成事件
                document.addEventListener('cardsLoaded', function onCardsLoaded() {
                    // 卡片加载完成后等待一小段时间再开始动画
                    setTimeout(() => startProgressAnimation(percentage, loginCount), 300);
                    
                    // 移除事件监听器，避免重复执行
                    document.removeEventListener('cardsLoaded', onCardsLoaded);
                });
            }
        }

        /**
         * 获取登录统计信息
         */
        async function fetchLoginStats() {
            try {
                console.log('正在获取登录统计...');
                const response = await fetch('/profile/api/user/login-stats');
                
                if (!response.ok) {
                    // 处理错误但不重定向
                    if (response.status === 401) {
                        console.warn('获取登录统计时用户未授权');
                        return;
                    }
                    throw new Error('获取登录统计失败');
                }
                
                const statsData = await response.json();
                console.log('登录统计获取成功');
                
                // 从登录统计中提取客户端信息并更新UI
                if (statsData && statsData.client_stats) {
                    displayRecentClients(statsData.client_stats, statsData);
                } else {
                    displayRecentClientsError('无法获取客户端统计信息');
                }
            } catch (error) {
                console.error('获取登录统计失败:', error);
                displayRecentClientsError('无法加载登录统计信息');
            }
        }
        
        /**
         * 显示最近登录的客户端
         * @param {Array} clientStats - 客户端统计数据
         * @param {Object} statsData - 统计总数据
         */
        function displayRecentClients(clientStats, statsData) {
            const container = document.getElementById('recent-clients-list');
            
            // 清空加载指示器
            container.innerHTML = '';
            
            if (!clientStats || clientStats.length === 0) {
                container.innerHTML = '<div class="loading-indicator">没有找到最近的登录记录</div>';
                return;
            }
            
            // 添加时间范围信息
            addDateRangeInfo(container, statsData);
            
            // 对客户端按照最后登录时间排序（最近的在前）
            const sortedClients = sortClientsByLastLogin(clientStats);
            
            // 为每个客户端创建一个项目
            createClientElements(container, sortedClients);
        }
        
        /**
         * 添加日期范围信息
         * @param {HTMLElement} container - 容器元素
         * @param {Object} statsData - 统计数据
         */
        function addDateRangeInfo(container, statsData) {
            let dayRange = 30; // 默认30天
            
            if (statsData && statsData.start_date && statsData.end_date) {
                const startDate = new Date(statsData.start_date);
                const endDate = new Date(statsData.end_date);
                dayRange = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
                
                const rangeElement = document.createElement('div');
                rangeElement.className = 'date-range-info';
                rangeElement.style.marginBottom = '15px';
                rangeElement.style.color = '#aaaaaa';
                rangeElement.textContent = `最近${dayRange}天`;
                container.appendChild(rangeElement);
            }
        }
        
        /**
         * 按最后登录时间排序客户端
         * @param {Array} clientStats - 客户端统计数据
         * @returns {Array} 排序后的客户端数组
         */
        function sortClientsByLastLogin(clientStats) {
            return [...clientStats].sort((a, b) => {
                const lastLoginA = new Date(a.last_login);
                const lastLoginB = new Date(b.last_login);
                return lastLoginB - lastLoginA; // 降序排列，最近的在前
            });
        }
        
        /**
         * 创建客户端元素
         * @param {HTMLElement} container - 容器元素
         * @param {Array} clients - 客户端数组
         */
        function createClientElements(container, clients) {
            clients.forEach((client, index) => {
                // 格式化最后登录时间
                const lastLogin = new Date(client.last_login);
                const timeAgo = getTimeAgo(lastLogin);
                
                // 确定客户端图标
                const clientIcon = getClientIcon(client.client_name);
                
                // 创建客户端元素
                const clientElement = document.createElement('div');
                clientElement.className = 'interactive-item';
                clientElement.style.opacity = '0';
                clientElement.style.transform = 'translateY(10px)';
                clientElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                clientElement.innerHTML = `
                    <div class="item-icon">${clientIcon}</div>
                    <div class="item-text">
                        <div class="item-title">${client.client_name}</div>
                        <div class="item-desc">
                            <span style="color: #ccc; font-weight: 500;">${timeAgo}</span> · 共登录 ${client.login_count} 次
                        </div>
                    </div>
                `;
                
                container.appendChild(clientElement);
                
                // 错开显示每个客户端项
                setTimeout(() => {
                    clientElement.style.opacity = '1';
                    clientElement.style.transform = 'translateY(0)';
                }, 100 + (index * 80));
            });
        }
        
        /**
         * 获取客户端图标
         * @param {string} clientName - 客户端名称
         * @returns {string} 图标
         */
        function getClientIcon(clientName) {
            const name = clientName.toLowerCase();
            
            if (name.includes('web') || name.includes('网页')) return '🌐';
            if (name.includes('desktop') || name.includes('桌面')) return '💻';
            if (name.includes('mobile') || name.includes('手机')) return '📱';
            
            return '🔹'; // 默认图标
        }
        
        /**
         * 显示最近登录客户端的错误
         * @param {string} message - 错误信息
         */
        function displayRecentClientsError(message) {
            console.warn('显示客户端错误:', message);
            const container = document.getElementById('recent-clients-list');
            container.innerHTML = `<div class="loading-indicator" style="color: #ff8888;">${message}</div>`;
        }
        
        /**
         * 计算时间差（几天前、几小时前等）
         * @param {Date} date - 要计算的日期
         * @returns {string} 格式化后的时间差
         */
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHours = Math.floor(diffMin / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffDays > 0) {
                if (diffDays === 1) {
                    return '昨天';
                } else if (diffDays < 7) {
                    return `${diffDays} 天前`;
                } else if (diffDays < 31) {
                    const weeks = Math.floor(diffDays / 7);
                    return weeks === 1 ? '1 周前' : `${weeks} 周前`;
                } else {
                    const months = Math.floor(diffDays / 30);
                    return months === 1 ? '1 个月前' : `${months} 个月前`;
                }
            } else if (diffHours > 0) {
                return diffHours === 1 ? '1 小时前' : `${diffHours} 小时前`;
            } else if (diffMin > 0) {
                return diffMin === 1 ? '1 分钟前' : `${diffMin} 分钟前`;
            } else if (diffSec > 30) {
                return `${diffSec} 秒前`;
            } else {
                return '刚刚';
            }
        }

        /**
         * 上传头像
         * @param {File} file - 要上传的文件
         */
        async function uploadAvatar(file) {
            try {
                console.log('正在上传头像...');
                
                // 创建FormData对象
                const formData = new FormData();
                formData.append('avatar', file);
                
                // 发送请求
                const uploadResponse = await fetch('/profile/api/upload-avatar', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json();
                    throw new Error(errorData.error || '上传头像失败');
                }
                
                console.log('头像上传成功');
                
                // 上传成功
                showToast('头像上传成功', 'success');
                
                // 添加时间戳参数以强制更新缓存的头像
                refreshAvatarCache();
                
                // 重新加载用户信息以更新头像
                setTimeout(() => {
                    fetchUserInfo();
                }, 1000);
                
            } catch (error) {
                console.error('上传头像失败:', error);
                showToast(error.message || '上传头像失败', 'error');
            }
        }
        
        /**
         * 刷新头像缓存
         */
        function refreshAvatarCache() {
            const timestamp = new Date().getTime();
            const userAvatar = document.getElementById('user-avatar');
            
            // 如果当前头像是URL（非data:开头的URI），添加时间戳参数
            if (userAvatar.src && !userAvatar.src.startsWith('data:')) {
                // 处理URL，添加或更新时间戳参数
                let avatarUrl = new URL(userAvatar.src);
                avatarUrl.searchParams.set('t', timestamp);
                userAvatar.src = avatarUrl.toString();
            }
        }
    </script>
</body>
</html> 